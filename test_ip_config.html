<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ IP Configuration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2E7D32; }
        h2 { color: #4CAF50; margin-top: 0; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #388E3C; }
        input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 300px;
            margin: 5px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .log {
            background: #263238;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üß™ Smart Greenhouse IP Configuration Test</h1>
    
    <div class="test-box">
        <h2>1. Auto-Detection Test</h2>
        <div id="detectionResult" class="status info">Testing...</div>
        <p><strong>Current hostname:</strong> <code id="hostname">-</code></p>
        <p><strong>Detected mode:</strong> <code id="mode">-</code></p>
        <p><strong>Base URL:</strong> <code id="baseUrl">-</code></p>
    </div>
    
    <div class="test-box">
        <h2>2. LocalStorage Test</h2>
        <input type="text" id="testIp" placeholder="Enter test IP (e.g., 192.168.1.100)">
        <button onclick="testSaveIP()">üíæ Save</button>
        <button onclick="testLoadIP()">üìÇ Load</button>
        <button onclick="testClearIP()">üóëÔ∏è Clear</button>
        <div id="storageResult" class="status info">Ready for testing...</div>
    </div>
    
    <div class="test-box">
        <h2>3. API Connection Test</h2>
        <input type="text" id="apiTestIp" placeholder="ESP32 IP (e.g., 192.168.1.100)">
        <button onclick="testAPI()">üîç Test /api</button>
        <button onclick="testHistory()">üìä Test /history</button>
        <div id="apiResult" class="status info">Enter ESP32 IP and click test...</div>
    </div>
    
    <div class="test-box">
        <h2>4. CORS Test</h2>
        <button onclick="testCORS()">üåê Test CORS Headers</button>
        <div id="corsResult" class="status info">Click to test CORS configuration...</div>
    </div>
    
    <div class="test-box">
        <h2>üìù Console Log</h2>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        <div id="consoleLog" class="log"></div>
    </div>

    <script>
        let ESP32_BASE_URL = '';
        let isLocalMode = false;
        
        // Logger
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('consoleLog');
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                error: '#ff4444',
                success: '#44ff44',
                warning: '#ffaa00'
            };
            logDiv.innerHTML += `<div style="color: ${colors[type]}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
        }
        
        // Test 1: Auto-Detection
        function testDetection() {
            const hostname = window.location.hostname;
            isLocalMode = hostname.match(/^\d+\.\d+\.\d+\.\d+$/) || hostname === 'localhost';
            
            document.getElementById('hostname').textContent = hostname;
            document.getElementById('mode').textContent = isLocalMode ? 'Local (ESP32)' : 'Remote (GitHub Pages)';
            
            if (isLocalMode) {
                ESP32_BASE_URL = '';
                document.getElementById('baseUrl').textContent = 'Relative URLs (/api)';
                document.getElementById('detectionResult').className = 'status success';
                document.getElementById('detectionResult').textContent = '‚úÖ Local mode detected - No configuration needed!';
                log('‚úÖ Local mode detected', 'success');
            } else {
                const savedIP = localStorage.getItem('esp32_ip');
                if (savedIP) {
                    ESP32_BASE_URL = `http://${savedIP}`;
                    document.getElementById('baseUrl').textContent = ESP32_BASE_URL;
                    document.getElementById('detectionResult').className = 'status success';
                    document.getElementById('detectionResult').textContent = `‚úÖ Remote mode - Using saved IP: ${savedIP}`;
                    log(`‚úÖ Remote mode - Using saved IP: ${savedIP}`, 'success');
                } else {
                    document.getElementById('baseUrl').textContent = 'Not configured';
                    document.getElementById('detectionResult').className = 'status error';
                    document.getElementById('detectionResult').textContent = '‚ö†Ô∏è Remote mode - Please configure ESP32 IP';
                    log('‚ö†Ô∏è Remote mode - IP not configured', 'warning');
                }
            }
        }
        
        // Test 2: LocalStorage
        function testSaveIP() {
            const ip = document.getElementById('testIp').value.trim();
            if (!ip) {
                document.getElementById('storageResult').className = 'status error';
                document.getElementById('storageResult').textContent = '‚ùå Please enter an IP address';
                log('‚ùå No IP entered', 'error');
                return;
            }
            
            const ipPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?$/;
            if (!ipPattern.test(ip)) {
                document.getElementById('storageResult').className = 'status error';
                document.getElementById('storageResult').textContent = '‚ùå Invalid IP format';
                log(`‚ùå Invalid IP format: ${ip}`, 'error');
                return;
            }
            
            localStorage.setItem('esp32_ip', ip);
            ESP32_BASE_URL = `http://${ip}`;
            document.getElementById('storageResult').className = 'status success';
            document.getElementById('storageResult').textContent = `‚úÖ IP saved: ${ip}`;
            log(`‚úÖ IP saved to localStorage: ${ip}`, 'success');
            testDetection(); // Refresh detection
        }
        
        function testLoadIP() {
            const savedIP = localStorage.getItem('esp32_ip');
            if (savedIP) {
                document.getElementById('testIp').value = savedIP;
                document.getElementById('storageResult').className = 'status success';
                document.getElementById('storageResult').textContent = `‚úÖ Loaded IP: ${savedIP}`;
                log(`‚úÖ Loaded IP from localStorage: ${savedIP}`, 'success');
            } else {
                document.getElementById('storageResult').className = 'status info';
                document.getElementById('storageResult').textContent = '‚ÑπÔ∏è No IP saved in localStorage';
                log('‚ÑπÔ∏è No IP found in localStorage', 'info');
            }
        }
        
        function testClearIP() {
            localStorage.removeItem('esp32_ip');
            document.getElementById('testIp').value = '';
            ESP32_BASE_URL = '';
            document.getElementById('storageResult').className = 'status info';
            document.getElementById('storageResult').textContent = 'üóëÔ∏è IP cleared from localStorage';
            log('üóëÔ∏è IP cleared from localStorage', 'info');
            testDetection(); // Refresh detection
        }
        
        // Test 3: API Connection
        async function testAPI() {
            const ip = document.getElementById('apiTestIp').value.trim();
            if (!ip) {
                document.getElementById('apiResult').className = 'status error';
                document.getElementById('apiResult').textContent = '‚ùå Please enter ESP32 IP';
                return;
            }
            
            const url = `http://${ip}/api`;
            log(`üîç Testing API: ${url}`, 'info');
            document.getElementById('apiResult').className = 'status info';
            document.getElementById('apiResult').textContent = `‚è≥ Testing ${url}...`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('apiResult').className = 'status success';
                document.getElementById('apiResult').innerHTML = `‚úÖ API Success!<br>
                    Temperature: ${data.temperature}¬∞C<br>
                    Pressure: ${data.pressure} hPa<br>
                    Light: ${data.light} lux<br>
                    Soil: ${data.soil}%`;
                log(`‚úÖ API test successful: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                document.getElementById('apiResult').className = 'status error';
                document.getElementById('apiResult').textContent = `‚ùå API Error: ${error.message}`;
                log(`‚ùå API test failed: ${error.message}`, 'error');
            }
        }
        
        async function testHistory() {
            const ip = document.getElementById('apiTestIp').value.trim();
            if (!ip) {
                document.getElementById('apiResult').className = 'status error';
                document.getElementById('apiResult').textContent = '‚ùå Please enter ESP32 IP';
                return;
            }
            
            const url = `http://${ip}/history`;
            log(`üìä Testing History: ${url}`, 'info');
            document.getElementById('apiResult').className = 'status info';
            document.getElementById('apiResult').textContent = `‚è≥ Testing ${url}...`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('apiResult').className = 'status success';
                document.getElementById('apiResult').innerHTML = `‚úÖ History Success!<br>
                    Data points: ${data.temperature ? data.temperature.length : 0}<br>
                    First reading: ${data.timestamps ? new Date(data.timestamps[0] * 1000).toLocaleString() : 'N/A'}`;
                log(`‚úÖ History test successful: ${data.temperature ? data.temperature.length : 0} points`, 'success');
            } catch (error) {
                document.getElementById('apiResult').className = 'status error';
                document.getElementById('apiResult').textContent = `‚ùå History Error: ${error.message}`;
                log(`‚ùå History test failed: ${error.message}`, 'error');
            }
        }
        
        // Test 4: CORS
        async function testCORS() {
            const ip = document.getElementById('apiTestIp').value.trim() || localStorage.getItem('esp32_ip');
            if (!ip) {
                document.getElementById('corsResult').className = 'status error';
                document.getElementById('corsResult').textContent = '‚ùå Please configure IP first';
                return;
            }
            
            const url = `http://${ip}/api`;
            log(`üåê Testing CORS headers: ${url}`, 'info');
            document.getElementById('corsResult').className = 'status info';
            document.getElementById('corsResult').textContent = '‚è≥ Testing CORS...';
            
            try {
                const response = await fetch(url);
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                
                if (corsHeader === '*') {
                    document.getElementById('corsResult').className = 'status success';
                    document.getElementById('corsResult').innerHTML = `‚úÖ CORS Configured Correctly!<br>
                        Access-Control-Allow-Origin: ${corsHeader}`;
                    log('‚úÖ CORS headers present and correct', 'success');
                } else {
                    document.getElementById('corsResult').className = 'status error';
                    document.getElementById('corsResult').textContent = `‚ö†Ô∏è CORS header missing or incorrect: ${corsHeader}`;
                    log(`‚ö†Ô∏è CORS header: ${corsHeader}`, 'warning');
                }
            } catch (error) {
                document.getElementById('corsResult').className = 'status error';
                document.getElementById('corsResult').textContent = `‚ùå CORS Test Failed: ${error.message}`;
                log(`‚ùå CORS test failed: ${error.message}`, 'error');
            }
        }
        
        // Run detection on load
        window.onload = function() {
            log('üöÄ Test page loaded', 'info');
            testDetection();
        };
    </script>
</body>
</html>
